

<div class="lecture-source">
   <h2 id="how-every-new-rails-project-starts">How every new rails project starts</h2>
<h2 id="new-rails-application">New Rails application</h2>

 <p>First, go to your personal code folder:</p>
 <div class="language-bash highlighter-rouge">
    <div class="highlight github">
       <pre class="highlight github"><code><span class="nb">cd</span> ~/code/<span class="nv">$GITHUB_USERNAME</span>
</code></pre>
    </div>
 </div>
<p>Generate a blog with the <strong><code>--database</code> flag</strong>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">cd</span> ~/code/<span class="nv">$YOUR_GITHUB_USERNAME</span>
<span class="nb">rails </span>new blog <span class="nt">--database</span><span class="o">=</span>postgresql
<span class="nb">cd </span>blog
</code></pre></div></div>

<p>Create the database on PostgreSQL</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>db:create
</code></pre></div></div>

<p><br></p>

<p>Init and push your git repo</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">git </span>add <span class="nb">.</span>
<span class="nb">git </span>commit <span class="nt">-m</span> <span class="s2">"Initial commit"</span>
<span class="nb">hub </span>create
<span class="nb">git </span>push origin master
</code></pre></div></div>

<p>Look at your <code>Gemfile</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'pg'</span>  <span class="c1"># No more `gem 'sqlite'` thanks to `--database=postgresql`</span>
</code></pre></div></div>

<h3 id="quick-wagon-setup">Quick Wagon Setup</h3>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c"># Terminal</span>
<span class="nb">yarn </span>add bootstrap jquery popper.js
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'simple_form'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">bundle </span>install
<span class="nb">rails </span>generate simple_form:install <span class="nt">--bootstrap</span>
rm app/assets/stylesheets/application.css
<span class="nb">touch </span>app/assets/stylesheets/application.scss
</code></pre></div></div>

<div class="language-css highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c">/* app/assets/stylesheets/application.scss */</span>
<span class="k">@import</span> <span class="s1">"bootstrap/scss/bootstrap"</span><span class="p">;</span>
</code></pre></div></div>
<hr>
<hr>

<h2 id="what-well-use">DEVISE</h2>

<p><strong>Devise</strong> An authentication gem for Rails</p>

<p>https://github.com/plataformatec/devise/</p>

<h3 id="start-with-a-rails-minimal-template">Start with a rails minimal template</h3>

<p>Le Wagon‚Äôs <a href="https://github.com/lewagon/rails-templates/tree/master#minimal" target="_blank">Rails Minimal Template</a></p>

<h3 id="installation">Installation</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'devise'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">bundle </span>install
<span class="nb">rails </span>generate devise:install
</code></pre></div></div>

<h3 id="configuration">Configuration</h3>

<pre><code class="language-text">Some setup you must do manually if you haven't yet:

  1. Ensure you have defined default url options in your environments files. Here
     is an example of default_url_options appropriate for a development environment
     in config/environments/development.rb:

       config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }

     In production, :host should be set to the actual host of your application.

  2. Ensure you have defined root_url to *something* in your config/routes.rb.
     For example:

       root to: "pages#home"

  3. Ensure you have flash messages in app/views/layouts/application.html.erb.
     For example:

       &lt;p class="notice"&gt;&lt;%= notice %&gt;&lt;/p&gt;
       &lt;p class="alert"&gt;&lt;%= alert %&gt;&lt;/p&gt;
</code></pre>

<h2 id="initializer">Initializer</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># config/initializers/devise.rb</span>

<span class="c1"># ==&gt; Mailer Configuration</span>
<span class="c1"># Configure the e-mail address which will be shown in Devise::Mailer,</span>
<span class="c1"># note that it will be overwritten if you use your own mailer class</span>
<span class="c1"># with default "from" parameter.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">mailer_sender</span> <span class="o">=</span> <span class="s1">'please-change-me-at-config-initializers-devise@example.com'</span>
</code></pre></div></div>

<p>‚Äì</p>
<h3 id="user-model">User Model</h3>

<p>Generate the <code>User</code> model with the <strong>devise</strong> generator (not <code>model</code> nor <code>scaffold</code>).</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>generate devise User
<span class="c">#      invoke  active_record</span>
<span class="c">#      create    db/migrate/TIMESTAMP_devise_create_users.rb</span>
<span class="c">#      create    app/models/user.rb</span>
<span class="c">#      insert    app/models/user.rb</span>
<span class="c">#       route  devise_for :users</span>
</code></pre></div></div>

<p>This <strong>creates</strong> the <code>User</code> model and its migration. So run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>db:migrate
</code></pre></div></div>

<h2 id="look-1">Look! (1)</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># app/models/user.rb</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># Include default devise modules. Others available are:</span>
  <span class="c1"># :confirmable, :lockable, :timeoutable, :trackable and :omniauthable</span>
  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span>
         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:validatable</span>
<span class="k">end</span>
</code></pre></div></div>
<!-- .element: class="model" -->

<h2 id="look-2">Look! (2)</h2>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>routes
<span class="nb">rails </span>routes | <span class="nb">grep </span>new_
</code></pre></div></div>

<p>Let‚Äôs sign up!</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>s
</code></pre></div></div>

<p>And go to <a href="http://localhost:3000/users/sign_up" target="_blank">localhost:3000/users/sign_up</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>c
<span class="o">[</span>1] pry<span class="o">(</span>main<span class="o">)&gt;</span> User.count
<span class="o">[</span>2] pry<span class="o">(</span>main<span class="o">)&gt;</span> User.last
</code></pre></div></div>

<h2 id="views">Views</h2>

<h3 id="helpers">Helpers</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="n">user_signed_in?</span>
<span class="c1"># =&gt; true / false</span>

<span class="n">current_user</span>
<span class="c1"># =&gt; User instance / nil</span>
</code></pre></div></div>

<h3 id="navbar">Navbar</h3>

<p>You need a Log in / Logout logic.</p>

<p>You can start from this <a href="https://github.com/lewagon/awesome-navbars/blob/master/templates/_navbar_wagon.html.erb" target="_blank">navbar template</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">mkdir </span>app/views/shared
curl https://raw.githubusercontent.com/lewagon/awesome-navbars/master/templates/_navbar_wagon.html.erb <span class="o">&gt;</span> app/views/shared/_navbar.html.erb
curl https://raw.githubusercontent.com/lewagon/karr-images/master/white_logo_red_circle.png <span class="o">&gt;</span> app/assets/images/logo.png
</code></pre></div></div>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c">&lt;!-- app/views/layouts/application.html.erb --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/navbar'</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<h3 id="alerts">Alerts</h3>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c">&lt;!-- app/views/layouts/application.html.erb --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/flashes'</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c">&lt;!-- app/views/shared/_flashes.html.erb --&gt;</span>
<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">notice</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-info alert-dismissible"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span> <span class="na">aria-label=</span><span class="s">"Close"</span><span class="nt">&gt;&lt;span</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/span&gt;&lt;/button&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">notice</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">alert</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-warning alert-dismissible"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span> <span class="na">aria-label=</span><span class="s">"Close"</span><span class="nt">&gt;&lt;span</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/span&gt;&lt;/button&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">alert</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<h3 id="customize-devise-views">Customize devise views</h3>

<p>Sign in / Sign up / Forget password / [‚Ä¶]</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>g devise:views
</code></pre></div></div>

<p>And look into <code>app/views/devise</code> folder.</p>

<h2 id="controller">Controller</h2>

<h3 id="white-list-approach">White-list approach</h3>

<p>Protect <strong>every route</strong> by default.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># app/controllers/application_controller.rb</span>
<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>
<span class="k">end</span>
</code></pre></div></div>
<!-- .element: class="controller" -->

<h3 id="skipping-login-for-some-pages">Skipping login for some pages</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># app/controllers/pages_controller.rb</span>
<span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">skip_before_action</span> <span class="ss">:authenticate_user!</span><span class="p">,</span> <span class="ss">only: :home</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<!-- .element: class="controller" -->

<h3 id="adding-attributes-to-user">Adding attributes to <code>User</code></h3>

<p>What if I want to add a <code>first_name</code> and <code>last_name</code> at sign up?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># [...]</span>
  <span class="n">before_action</span> <span class="ss">:configure_permitted_parameters</span><span class="p">,</span> <span class="ss">if: :devise_controller?</span>

  <span class="k">def</span> <span class="nf">configure_permitted_parameters</span>
    <span class="c1"># For additional fields in app/views/devise/registrations/new.html.erb</span>
    <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:sign_up</span><span class="p">,</span> <span class="ss">keys: </span><span class="p">[</span><span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">])</span>

    <span class="c1"># For additional in app/views/devise/registrations/edit.html.erb</span>
    <span class="n">devise_parameter_sanitizer</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:account_update</span><span class="p">,</span> <span class="ss">keys: </span><span class="p">[</span><span class="ss">:username</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Read more <a href="https://github.com/plataformatec/devise#strong-parameters" target="_blank">in the documentation</a></p>

<hr>
<hr>
<h2 id="pundit-setup-1">PUNDIT</h2>

<h3 id="pundit-setup-1">Pundit Setup (1)</h3>

<pre><code class="language-Ruby"># Gemfile
gem 'pundit'
</code></pre>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">bundle </span>install
<span class="nb">rails </span>g pundit:install
</code></pre></div></div>

<h3 id="pundit-setup-2">Pundit Setup (2)</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># [...]</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_user!</span>
  <span class="kp">include</span> <span class="no">Pundit</span>

  <span class="c1"># Pundit: white-list approach.</span>
  <span class="n">after_action</span> <span class="ss">:verify_authorized</span><span class="p">,</span> <span class="ss">except: :index</span><span class="p">,</span> <span class="ss">unless: :skip_pundit?</span>
  <span class="n">after_action</span> <span class="ss">:verify_policy_scoped</span><span class="p">,</span> <span class="ss">only: :index</span><span class="p">,</span> <span class="ss">unless: :skip_pundit?</span>

  <span class="c1"># Uncomment when you *really understand* Pundit!</span>
  <span class="c1"># rescue_from Pundit::NotAuthorizedError, with: :user_not_authorized</span>
  <span class="c1"># def user_not_authorized</span>
  <span class="c1">#   flash[:alert] = "You are not authorized to perform this action."</span>
  <span class="c1">#   redirect_to(root_path)</span>
  <span class="c1"># end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">skip_pundit?</span>
    <span class="n">devise_controller?</span> <span class="o">||</span> <span class="n">params</span><span class="p">[</span><span class="ss">:controller</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">/(^(rails_)?admin)|(^pages$)/</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="usage">Usage</h3>

<h3 id="protect-restaurant">Protect <code>Restaurant</code></h3>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>g pundit:policy restaurant
<span class="c"># =&gt; generates the file `app/policies/restaurant_policy.rb`</span>
</code></pre></div></div>

<p><strong>Question</strong>: Who can create a restaurant?</p>

<h3 id="anyone">Anyone</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># app/policies/restaurant_policy.rb</span>
<span class="k">class</span> <span class="nc">RestaurantPolicy</span> <span class="o">&lt;</span> <span class="no">ApplicationPolicy</span>
  <span class="c1"># [...]</span>

  <span class="k">def</span> <span class="nf">create?</span>
    <span class="k">return</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And in the controller, use</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="n">authorize</span> <span class="vi">@restaurant</span>
</code></pre></div></div>

<h3 id="update-the-views">Update the views!</h3>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">policy</span><span class="p">(</span><span class="no">Restaurant</span><span class="p">).</span><span class="nf">create?</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"New restaurant"</span><span class="p">,</span> <span class="n">new_restaurant_path</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>Passing a <strong>class</strong> to <code>policy</code> as we don‚Äôt have a specific restaurant instance.</p>

<p>Rinse &amp; repeat for <code>update</code> and <code>destroy</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># app/policies/restaurant_policy.rb</span>
<span class="k">class</span> <span class="nc">RestaurantPolicy</span> <span class="o">&lt;</span> <span class="no">ApplicationPolicy</span>
  <span class="k">def</span> <span class="nf">update?</span>
    <span class="n">record</span><span class="p">.</span><span class="nf">user</span> <span class="o">==</span> <span class="n">user</span>
    <span class="c1"># - record: the restaurant passed to the `authorize` method in controller</span>
    <span class="c1"># - user:   the `current_user` signed in with Devise.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy?</span>
    <span class="n">record</span><span class="p">.</span><span class="nf">user</span> <span class="o">==</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In the view we can use <code>policy</code> with an <strong>instance</strong>.</p>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="cp">&lt;%</span> <span class="vi">@restaurants</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">restaurant</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">policy</span><span class="p">(</span><span class="n">restaurant</span><span class="p">).</span><span class="nf">edit?</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Update"</span><span class="p">,</span> <span class="n">edit_restaurant_path</span><span class="p">(</span><span class="n">restaurant</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<h3 id="scope">Scope</h3>

<p>Special case for <code>index</code> action:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># app/controllers/restaurants_controller.rb</span>
<span class="k">class</span> <span class="nc">RestaurantsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@restaurants</span> <span class="o">=</span> <span class="n">policy_scope</span><span class="p">(</span><span class="no">Restaurant</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="ss">created_at: :desc</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># app/policies/restaurant_policy.rb</span>
<span class="k">class</span> <span class="nc">RestaurantPolicy</span> <span class="o">&lt;</span> <span class="no">ApplicationPolicy</span>
  <span class="k">class</span> <span class="nc">Scope</span> <span class="o">&lt;</span> <span class="no">Scope</span>
    <span class="k">def</span> <span class="nf">resolve</span>
      <span class="n">scope</span><span class="p">.</span><span class="nf">all</span>

      <span class="c1"># For a multi-tenant SaaS app, you may want to use:</span>
      <span class="c1"># scope.where(user: user)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="example-code">Example code</h3>

<p>See <a href="https://github.com/lewagon/rails-pundit/compare/app-without-authorization...app-with-authorization?diff=split&amp;name=app-with-authorization" target="_blank">lewagon/rails-pundit</a></p>

<p>And read <a href="https://github.com/elabs/pundit" target="_blank">all the doc</a></p>

<h3 id="admin-users">Admin users</h3>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>g migration AddAdminToUsers admin:boolean
<span class="nb">rails </span>db:migrate
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>c
pry&gt; user <span class="o">=</span> User.where<span class="o">(</span>email: <span class="s1">'seb@lewagon.org'</span><span class="o">)</span>.first
pry&gt; user.admin <span class="o">=</span> true
pry&gt; user.save
</code></pre></div></div>

<p>You can now use this <code>admin</code> field in your policies!</p>

<hr>
<hr>


<h2 id="heroku"><a href="https://www.heroku.com/" target="_blank">Heroku</a></h2>

<h3 id="help">Help</h3>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">heroku
</span>Usage: <span class="nb">heroku </span>COMMAND <span class="o">[</span><span class="nt">--app</span> APP] <span class="o">[</span>command-specific-options]
Primary help topics, type <span class="s2">"heroku help TOPIC"</span> <span class="k">for </span>more details:
  addons     <span class="c"># manage addon resources</span>
  apps       <span class="c"># manage apps (create, destroy)</span>
  auth       <span class="c"># authentication (login, logout)</span>
  config     <span class="c"># manage app config vars</span>
  domains    <span class="c"># manage custom domains</span>
  logs       <span class="c"># display logs for an app</span>
  ps         <span class="c"># manage dynos (dynos, workers)</span>
  releases   <span class="c"># manage app releases</span>
  run        <span class="c"># run one-off commands (console, rake)</span>
  sharing    <span class="c"># manage collaborators on an app</span>
</code></pre></div></div>

<h3 id="login">Login</h3>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">heroku </span>login
</code></pre></div></div>

<h3 id="create-an-heroku-app">Create an Heroku app</h3>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">heroku </span>create <span class="nv">$YOUR_APP_NAME</span> <span class="nt">--region</span> eu
</code></pre></div></div>

<p><code>eu</code> / <code>us</code> are the common <a href="https://devcenter.heroku.com/articles/regions#view-the-list-of-available-regions" target="_blank">regions</a>.</p>

<h2 id="what-happened">What happened?</h2>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">git </span>remote <span class="nt">-v</span>
</code></pre></div></div>

<h2 id="lets-deploy">Let‚Äôs deploy!</h2>

<p>Push your code to Heroku</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">git </span>push <span class="nb">heroku </span>master
</code></pre></div></div>

<p>Useful commands</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">heroku </span>open         <span class="c"># open in your browser</span>
<span class="nb">heroku </span>logs <span class="nt">--tail</span>  <span class="c"># show the app logs and keep listening</span>
</code></pre></div></div>

<h2 id="done">Done!</h2>

<p>Run a command on Heroku</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">heroku </span>run &lt;command&gt;         <span class="c"># Syntax</span>
<span class="nb">heroku </span>run <span class="nb">rails </span>db:migrate  <span class="c"># Run pending migrations in prod</span>
<span class="nb">heroku </span>run <span class="nb">rails </span>c           <span class="c"># Run the production console</span>
</code></pre></div></div>

<hr>
<hr>

<h2 id="image-upload">CLOUDINARY</h2>

<h3 id="image-upload">Image Upload</h3>

<p>User-side upload. Not <strong>assets</strong>.</p>

<h3 id="uploading--storing-to-heroku">Uploading / Storing to Heroku?</h3>

<p>You <em>can‚Äôt</em>: the dyno file system is <a href="https://devcenter.heroku.com/articles/dynos#ephemeral-filesystem" target="_blank"><strong>ephemeral</strong></a>.</p>

<p>We need an external service.</p>

<h3 id="cloudinary"><a href="http://www.cloudinary.com" target="_blank">Cloudinary</a></h3>

<h3 id="create-a-cloudinary-account">Create a Cloudinary account</h3>

<p><a href="https://cloudinary.com/users/register/free" target="_blank">Sign up</a> for a free account</p>

<p>‚ö†Ô∏è You may need to sign up using <strong>tethering</strong> as they might detect a ‚Äúsign up spam‚Äù.</p>

<p>Once signed up, cloudinary will provide you a unique <strong>key</strong> for your project.</p>

<h3 id="where-do-we-put-our-secret-keys">Where do we put our secret keys?</h3>

<p>We don‚Äôt want to share those secret keys on Github, we can use the <a href="https://github.com/bkeepers/dotenv" target="_blank">dotenv</a> gem for security.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'dotenv-rails'</span><span class="p">,</span> <span class="ss">groups: </span><span class="p">[</span><span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">bundle </span>install
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">touch</span> .env
<span class="nb">echo</span> <span class="s1">'.env*'</span> <span class="o">&gt;&gt;</span> .gitignore
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">git </span>status <span class="c"># .env should not be there, we don't want to push it to Github.</span>
<span class="nb">git </span>add <span class="nb">.</span>
<span class="nb">git </span>commit <span class="nt">-m</span> <span class="s2">"Add dotenv - Protect my secret data in .env file"</span>
</code></pre></div></div>

<h3 id="cloudinary--environment">Cloudinary &amp; Environment</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'cloudinary'</span><span class="p">,</span> <span class="s1">'~&gt; 1.16.0'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">bundle </span>install
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># .env</span>
<span class="no">CLOUDINARY_URL</span><span class="o">=</span><span class="n">cloudinary</span><span class="ss">:/</span><span class="o">/</span><span class="mi">298522699261255</span><span class="ss">:Qa1ZfO4syfbOC</span><span class="o">-***********************</span><span class="mi">8</span>
</code></pre></div></div>

<h2 id="active-storage">Active Storage</h2>

<p>It was a gem, but is now <a href="https://guides.rubyonrails.org/active_storage_overview.html" target="_blank">included in rails</a> (versions 5.2 and above). It allows you to upload files to cloud storage (like cloudinary) and attach those files to <strong>Models</strong>!</p>

<h3 id="setup">Setup</h3>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">rails </span>active_storage:install
<span class="nb">rails </span>db:migrate
</code></pre></div></div>

<p>This creates two tables in the database to handle the associations between our pictures uploaded on Cloudinary and <strong>any Model</strong> in our app.</p>

<h3 id="config">Config</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># config/storage.yml</span>
<span class="na">cloudinary</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Cloudinary</span>
</code></pre></div></div>

<p>Replace <code>:local</code> by <code>:cloudinary</code> in the config:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># config/environments/development.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">service</span> <span class="o">=</span> <span class="ss">:cloudinary</span>
</code></pre></div></div>

<h3 id="model">Model</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one_attached</span> <span class="ss">:photo</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And that is all you need! ü§ì</p>

<h3 id="view--controller">View &amp; Controller</h3>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c">&lt;!-- app/views/articles/_form.html.erb --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">simple_form_for</span><span class="p">(</span><span class="n">article</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="c">&lt;!-- [...] --&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:photo</span><span class="p">,</span> <span class="ss">as: :file</span> <span class="cp">%&gt;</span>
  <span class="c">&lt;!-- [...] --&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># app/controllers/articles_controller.rb</span>
<span class="k">def</span> <span class="nf">article_params</span>
  <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:article</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">:photo</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="displaying-the-image">Displaying the image</h3>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c">&lt;!-- app/views/articles/show.html.erb --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">cl_image_tag</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">photo</span><span class="p">.</span><span class="nf">key</span><span class="p">,</span> <span class="ss">height: </span><span class="mi">300</span><span class="p">,</span> <span class="ss">width: </span><span class="mi">400</span><span class="p">,</span> <span class="ss">crop: :fill</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<h3 id="usage-in-background-image">Usage in <code>background-image</code></h3>

<p>Example: <a href="https://uikit.lewagon.com/documentation#card_category" target="_blank">Card component</a>.</p>

<p>You must use <strong><code>cl_image_path</code></strong></p>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-category"</span> <span class="na">style=</span><span class="s">"background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('</span><span class="cp">&lt;%=</span> <span class="n">cl_image_path</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">photo</span><span class="p">.</span><span class="nf">key</span><span class="p">,</span> <span class="ss">height: </span><span class="mi">300</span><span class="p">,</span> <span class="ss">width: </span><span class="mi">400</span><span class="p">,</span> <span class="ss">crop: :fill</span> <span class="cp">%&gt;</span><span class="s">')"</span><span class="nt">&gt;</span>
  Cool article
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<h3 id="seed">Seed</h3>

<p>You can upload <a href="https://edgeguides.rubyonrails.org/active_storage_overview.html#attaching-file-io-objects" target="_blank">from a URL</a>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">require</span> <span class="s2">"open-uri"</span>

<span class="n">file</span> <span class="o">=</span> <span class="no">URI</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'https://giantbomb1.cbsistatic.com/uploads/original/9/99864/2419866-nes_console_set.png'</span><span class="p">)</span>
<span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">title: </span><span class="s1">'NES'</span><span class="p">,</span> <span class="ss">body: </span><span class="s2">"A great console"</span><span class="p">)</span>
<span class="n">article</span><span class="p">.</span><span class="nf">photo</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">io: </span><span class="n">file</span><span class="p">,</span> <span class="ss">filename: </span><span class="s1">'nes.png'</span><span class="p">,</span> <span class="ss">content_type: </span><span class="s1">'image/png'</span><span class="p">)</span>
</code></pre></div></div>

<p>Here we write <code>article.photo.attach(...)</code> because we wrote <code>has_one_attached :photo</code> in <code>app/models/article.rb</code></p>

<h3 id="helpful-active-storage-methods">Helpful Active Storage methods</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="vi">@article</span><span class="p">.</span><span class="nf">photo</span><span class="p">.</span><span class="nf">attached?</span> <span class="c1">#=&gt; true/false</span>
<span class="vi">@article</span><span class="p">.</span><span class="nf">photo</span><span class="p">.</span><span class="nf">purge</span> <span class="c1">#=&gt; Destroy the photo</span>
</code></pre></div></div>

<p>And many more in the <a href="https://guides.rubyonrails.org/v5.2.2/active_storage_overview.html" target="_blank">documentation</a></p>

<h3 id="multiple-images">Multiple images</h3>

<p>If you want to have many attached images, you can define a different relationship in your model:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:photos</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="view--controller-1">View &amp; Controller</h3>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c">&lt;!-- app/views/articles/_form.html.erb --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">simple_form_for</span><span class="p">(</span><span class="n">article</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="c">&lt;!-- [...] --&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">input</span> <span class="ss">:photos</span><span class="p">,</span> <span class="ss">as: :file</span><span class="p">,</span> <span class="ss">input_html: </span><span class="p">{</span> <span class="ss">multiple: </span><span class="kp">true</span> <span class="p">}</span> <span class="cp">%&gt;</span>
  <span class="c">&lt;!-- [...] --&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># app/controllers/articles_controller.rb</span>
<span class="k">def</span> <span class="nf">article_params</span>
  <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:article</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">photos: </span><span class="p">[])</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-erb highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c">&lt;!-- app/views/articles/show.html.erb --&gt;</span>
<span class="cp">&lt;%</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">photos</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">photo</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">cl_image_tag</span> <span class="n">photo</span><span class="p">.</span><span class="nf">key</span><span class="p">,</span> <span class="ss">height: </span><span class="mi">300</span><span class="p">,</span> <span class="ss">width: </span><span class="mi">400</span><span class="p">,</span> <span class="ss">crop: :fill</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<h2 id="production-4">Production</h2>

<p>Replace <code>:local</code> by <code>:cloudinary</code> in the config:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">service</span> <span class="o">=</span> <span class="ss">:cloudinary</span>
</code></pre></div></div>

<p>Make sure to push your <code>CLOUDINARY_URL</code> env variable to Heroku:</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">heroku </span>config:set <span class="nv">CLOUDINARY_URL</span><span class="o">=</span>cloudinary://166....
</code></pre></div></div>

<p>Check with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight github"><pre class="highlight github"><code><span class="nb">heroku </span>config
</code></pre></div></div>

<hr>
<hr>

   <h2 id="adding-pages">Adding pages</h2>
   <h3 id="generate-an-empty-controller">Generate an empty controller</h3>
   <div class="language-bash highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="nb">rails </span>generate controller pages
  <span class="c">#      create  app/controllers/pages_controller.rb</span>
  <span class="c">#      invoke  erb</span>
  <span class="c">#      create    app/views/pages</span>

  </code></pre>
      </div>
   </div>
   <p>Let‚Äôs add an <strong>about</strong> page to our app.</p>
   <p>What should the <strong>verb</strong> and <strong>url</strong> be?</p>
   <h3 id="route">Route</h3>
   <div class="language-ruby highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="c1"># config/routes.rb</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s1">'about'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'pages#about'</span>

    <span class="c1"># Generic syntax:</span>
    <span class="c1"># verb 'path', to: 'controller#action'</span>
  <span class="k">end</span>
  </code></pre>
      </div>
   </div>
   <!-- .element: class="router"  -->
   <h3 id="action">Action</h3>
   <div class="language-ruby highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="c1"># app/controller/pages_controller.rb</span>
  <span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">about</span>
    <span class="k">end</span>
  <span class="k">end</span>
  </code></pre>
      </div>
   </div>
   <h3 id="view">View</h3>
   <div class="language-html highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="c">&lt;!-- app/views/pages/about.html.erb --&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Our first view üöÄ<span class="nt">&lt;/h1&gt;</span>
  </code></pre>
      </div>
   </div>
   <h3 id="model-generator">Model Generator</h3>
   <div class="language-bash highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="nb">rails </span>generate model Restaurant name:string rating:integer
</code></pre>
      </div>
   </div>
   <div class="down-arrow"></div>
   <div class="language-bash highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code>      invoke  active_record
      create    db/migrate/YYYYMMDDHHMMSS_create_restaurants.rb
      create    app/models/restaurant.rb
</code></pre>
      </div>
   </div>
   <h3 id="auto-generated-files">Auto-generated files</h3>
   <div class="language-ruby highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="c1"># db/migrate/YYYYMMDDHHMMSS_create_restaurants.rb</span>
<span class="k">class</span> <span class="nc">CreateRestaurants</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:restaurants</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:rating</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
      </div>
   </div>
   <div class="language-ruby highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="c1"># app/models/restaurant.rb</span>
<span class="k">class</span> <span class="nc">Restaurant</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
      </div>
   </div>
   <!-- .element: class="model" -->
   <h3 id="do-not-forget-run-the-migrations">Do not forget: run the migrations</h3>
   <div class="language-bash highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="nb">rails </span>db:migrate
</code></pre>
      </div>
   </div>
   <p><br><br></p>
   <p>This will create (and update then) the <code>db/schema.rb</code> file which holds<br>
      all your table definitions. Refer to it when in doubt about a table name<br>
      or a column name.
   </p>
   <h3 id="and-of-course">And of course</h3>
   <div class="language-bash highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="nb">git </span>status
<span class="nb">git </span>add <span class="nb">.</span>
<span class="nb">git </span>commit <span class="nt">-m</span> <span class="s2">"Add restaurant model"</span>
</code></pre>
      </div>
   </div>
   <hr>
   <h2 id="migration-generator">Migration generator</h2>
   <p>Not the same as <strong>model</strong> generator! Use it to <strong>update</strong> an <strong>existing</strong> model.</p>
   <div class="language-bash highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="nb">rails </span>g migration AddAddressToRestaurants
</code></pre>
      </div>
   </div>
   <div class="down-arrow"></div>
   <div class="language-bash highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code>invoke  active_record
create  db/migrate/YYYYMMDDHHMMSS_add_address_to_restaurants.rb
</code></pre>
      </div>
   </div>
   <p>This generator creates a file skeleton. There‚Äôs still work to do.</p>
   <h3 id="write-your-migration-code">Write your migration code</h3>
   <p>The migration is empty by default. Populate the <code>change</code> method.</p>
   <div class="language-ruby highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="c1"># db/migrate/YYYYMMDDHHMMSS_add_address_to_restaurants.rb</span>

<span class="k">class</span> <span class="nc">AddAddressToRestaurants</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:restaurants</span><span class="p">,</span> <span class="ss">:address</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
      </div>
   </div>
   <div class="language-bash highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="nb">rails </span>db:migrate
</code></pre>
      </div>
   </div>
   <div class="language-bash highlighter-rouge">
      <div class="highlight github">
         <pre class="highlight github"><code><span class="nb">git </span>add <span class="nb">.</span>
<span class="nb">git </span>commit <span class="nt">-m</span> <span class="s2">"Add address to Restaurant"</span>
</code></pre>
      </div>
   </div>
   <h3 id="methods-to-be-used-in-change">Methods to be used in <code>change</code></h3>
   <ul>
      <li><code>add_column</code></li>
      <li><code>change_column</code></li>
      <li><code>rename_column</code></li>
      <li><code>remove_column</code></li>
      <li><code>add_reference</code></li>
   </ul>
   <p><br><br></p>
   <h2 id="rails-db-tasks">Rails DB tasks</h2>
   <ul>
      <li><strong><code>rails db:drop</code></strong> - Drop the database (lose all your data!)</li>
      <li><strong><code>rails db:create</code></strong> - Create the database with an empty schema</li>
      <li><strong><code>rails db:migrate</code></strong> - Run pending migrations on the database schema</li>
      <li><strong><code>rails db:rollback</code></strong> - Revert the last migration</li>
      <li><strong><code>rails db:reset</code></strong> - Drop database + create tables found in schema.rb</li>
   </ul>
   <hr>
</div>

